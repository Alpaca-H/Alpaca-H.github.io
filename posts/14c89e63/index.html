<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>keepalive+haproxyè´Ÿè½½å‡è¡¡ - Alpaca&#39;s blog | how to win</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="haproxyè´Ÿè½½å‡è¡¡">
<meta property="og:type" content="article">
<meta property="og:title" content="keepalive+haproxyè´Ÿè½½å‡è¡¡">
<meta property="og:url" content="http://blog.noback.top/posts/14c89e63/index.html">
<meta property="og:site_name" content="Alpaca&#39;s blog | how to win">
<meta property="og:description" content="haproxyè´Ÿè½½å‡è¡¡">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.noback.top/images/og_image.png">
<meta property="article:published_time" content="2020-01-07T09:45:56.000Z">
<meta property="article:modified_time" content="2020-01-07T09:45:56.000Z">
<meta property="article:author" content="ä½•æ³½å›">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="è´Ÿè½½å‡è¡¡">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.noback.top/images/og_image.png">







<link rel="icon" href="/images/datadog.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/androidstudio.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    

    


<link rel="stylesheet" href="/css/style.css">
<meta name="generator" content="Hexo 4.2.0"></head>
<body class="is-3-column" background="http://img.noback.top/background.jpg">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="http://image.noback.top/datadog.svg" alt="keepalive+haproxyè´Ÿè½½å‡è¡¡" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/rust/">rustğŸ¦€ï¸</a>
                
                <a class="navbar-item"
                href="/archives/">Archives</a>
                
                <a class="navbar-item"
                href="/categories/">Categories</a>
                
                <a class="navbar-item"
                href="/tags/">Tags</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="AlphaLxy GitHub" href="https://github.com/Alpaca-H/o">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="æœç´¢" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-10-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <i class="fas fa-angle-double-right"></i>keepalive+haproxyè´Ÿè½½å‡è¡¡
            
        </h1>
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-01-07T09:45:56.000Z"><i class="far fa-calendar-alt">&nbsp;</i>2020-01-07</time>
                
                
                <div class="level-item">
                <i class="far fa-folder-open has-text-grey"></i>&nbsp;
                <a class="has-link-grey -link" href="/categories/linux/">linux</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    <i class="far fa-clock"></i>&nbsp;
                    
                    
                    25 åˆ†é’Ÿ è¯»å®Œ (å¤§çº¦ 3705 ä¸ªå­—)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>æ¬¡è®¿é—®
                </span>
                
            </div>
        </div>
        
        <div class="content">
            <html><head></head><body><h2 id="haproxyè´Ÿè½½å‡è¡¡"><a href="#haproxyè´Ÿè½½å‡è¡¡" class="headerlink" title="haproxyè´Ÿè½½å‡è¡¡"></a>haproxyè´Ÿè½½å‡è¡¡</h2><a id="more"></a>

<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># yumå®‰è£…</span></span><br><span class="line">yum install haproxy -y <span class="hljs-comment"># centos7é»˜è®¤ç‰ˆæœ¬æ˜¯1.5</span></span><br><span class="line"><span class="hljs-comment"># æŸ¥çœ‹åŒ…ä¿¡æ¯</span></span><br><span class="line">rpm -qi haproxy</span><br><span class="line"><span class="hljs-comment"># æŸ¥çœ‹åŒ…æ‰€åˆ›å»ºçš„ç›®å½•</span></span><br><span class="line">rpm -ql haproxy</span><br></pre></td></tr></tbody></table></figure>

<hr>
<p>â€”->ä¸»è¦ç›®å½•<br>ä¸»ç¨‹åºï¼š/usr/sbin/haproxy<br>é…ç½®æ–‡ä»¶ï¼š/etc/haproxy/haproxy.cfg<br>å¯åŠ¨æœåŠ¡ï¼šsystemctl start haproxy<br>åœæ­¢æœåŠ¡ï¼šsystemctl stop haproxy<br>å¼€æœºå¯åŠ¨ï¼šsystemctl enable haproxy</p>
<p>â€”->é…ç½®æ–‡ä»¶ç»“æ„</p>
<p>haproxyé…ç½®æ–‡ä»¶å¯åˆ†ä¸ºå…¨å±€é…ç½®ï¼ˆglobalsettingsï¼‰å’Œ ä»£ç†é…ç½®ï¼ˆproxiesï¼‰ï¼Œè€Œä»£ç†æ®µé…ç½®åŒ…å«defaultsã€frontendã€backendã€listenã€‚</p>
<p>global settingsï¼š#å…¨å±€å‚æ•°é…ç½®ï¼Œä¸»è¦ç”¨äºå®šä¹‰haproxyè¿›ç¨‹ç®¡ç†å®‰å…¨åŠæ€§èƒ½ç›¸å…³çš„å‚æ•°<br>defaults < name >ï¼š#é»˜è®¤é…ç½®å‚æ•°ï¼Œä¸‹é¢çš„æ®µç»§æ‰¿è¯¥é…ç½®ï¼Œåç§°æ˜¯å¯é€‰çš„,è¿™é…ç½®é»˜è®¤é…ç½®å‚æ•°å¯ç”±ä¸‹ä¸€ä¸ªâ€defaultsâ€æ‰€é‡æ–°è®¾å®š<br>frontend < name >ï¼š#å‰ç«¯é…ç½®ï¼Œå®šä¹‰ä¸€ç³»åˆ—ç›‘å¬çš„å¥—æ¥å­—ï¼Œè¿™äº›å¥—æ¥å­—å¯æ¥å—å®¢æˆ·ç«¯è¯·æ±‚å¹¶ä¸ä¹‹å»ºç«‹è¿æ¥ï¼Œå¯ä»¥ç›‘å¬å¤šä¸ªç«¯å£ã€‚<br>backend < name >ï¼š#åç«¯é…ç½®ï¼Œå®šä¹‰åå°æœåŠ¡å™¨ï¼Œå‰ç«¯ä»£ç†æœåŠ¡å™¨å°†ä¼šæŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚è°ƒåº¦è‡³è¿™äº›æœåŠ¡å™¨ï¼Œç±»ä¼¼nginxä¸­çš„upstream<br>listen < name >ï¼š#å®šä¹‰ä¸€ç»„å‰ç«¯å’Œåç«¯çš„å®Œæ•´ä»£ç†ï¼Œå¯ç†è§£ä¸ºfrontend+backendï¼Œé€šå¸¸ç”¨äºtcpæµé‡ä»£ç†</p>
<p>â€”->é…ç½®å‚æ•°å¯æ”¯æŒçš„æ—¶é—´å•ä½</p>
<ul>
<li>us : å¾®ç§’. 1 microsecond = 1/1000000 s</li>
<li>ms : æ¯«ç§’. 1 millisecond = 1/1000 s</li>
<li>s  : ç§’  1s = 1000ms</li>
<li>m  : åˆ† 1m = 60s = 60000ms</li>
<li>h  : å°æ—¶   1h = 60m = 3600s = 3600000ms</li>
<li>d  : å¤©    1d = 24h = 1440m = 86400s = 86400000ms</li>
</ul>
<hr>
<p>haproxyé…ç½®æ–‡ä»¶</p>
<hr>
<p><strong>å…¨å±€é…ç½®å‚æ•°(global)</strong></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">chroot: <span class="hljs-comment">#ä¿®æ”¹haproxyçš„å·¥ä½œç›®å½•è‡³æŒ‡å®šçš„ç›®å½•ï¼Œå¹¶åœ¨æ”¾å¼ƒæƒé™ä¹‹å‰æ‰§è¡Œchrootï¼ˆï¼‰æ“ä½œï¼Œå¯ä»¥æå‡haproxyçš„å®‰å…¨çº§åˆ«ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ç¡®ä¿æŒ‡å®šçš„ç›®å½•ä¸ºç©ºç›®å½•ä¸”ä»»ä½•ç”¨æˆ·å‡ä¸èƒ½æœ‰å†™æƒé™;</span></span><br><span class="line">daemon: <span class="hljs-comment">#è®©haproxyä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å·¥ä½œäºåå°ï¼Œå…¶ç­‰åŒäº"-D"é€‰é¡¹çš„åŠŸèƒ½ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä»¥"-db"é€‰é¡¹å°†å…¶ç¦ç”¨;</span></span><br><span class="line">gid: <span class="hljs-comment">#ä»¥æŒ‡å®šçš„GIDè¿è¡Œhaproxyï¼Œå»ºè®®ä½¿ç”¨ä¸“ç”¨äºè¿è¡Œhaproxyçš„GIDï¼Œä»¥é¿å…å› æƒé™å¸¦æ¥çš„é£é™©;</span></span><br><span class="line">group: <span class="hljs-comment">#åŒgidï¼Œä¸è¿‡è¿™é‡Œä¸ºæŒ‡å®šçš„ç»„å;</span></span><br><span class="line">uid: <span class="hljs-comment">#å·²æŒ‡å®šçš„UIDèº«ä»½è¿è¡Œhaproxyè¿›ç¨‹;</span></span><br><span class="line">user: <span class="hljs-comment">#åŒuidï¼Œä½†è¿™é‡Œä½¿ç”¨çš„ä¸ºç”¨æˆ·å;</span></span><br><span class="line"><span class="hljs-built_in">log</span>: <span class="hljs-comment">#å®šä¹‰å…¨å±€çš„syslogæœåŠ¡å™¨ï¼Œæœ€å¤šå¯ä»¥å®šä¹‰ä¸¤ä¸ª;</span></span><br><span class="line">nbproc: <span class="hljs-comment">#æŒ‡å®šå¯åŠ¨çš„haproxyè¿›ç¨‹ä¸ªæ•°ï¼Œåªèƒ½ç”¨äºå®ˆæŠ¤è¿›ç¨‹æ¨¡å¼çš„haproxyï¼›é»˜è®¤ä¸ºæ­¢å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œé‰´äºè°ƒè¯•å›°éš¾ç­‰å¤šæ–¹é¢çš„åŸå› ï¼Œä¸€èˆ¬åªåœ¨ä½†è¿›ç¨‹ä»…èƒ½æ‰“å¼€å°‘æ•°æ–‡ä»¶æè¿°ç¬¦çš„åœºä¸­æ‰ä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å¼;</span></span><br><span class="line">pidfile: <span class="hljs-comment">#pidæ–‡ä»¶çš„å­˜æ”¾ä½ç½®;</span></span><br><span class="line"><span class="hljs-built_in">ulimit</span>-n:  <span class="hljs-comment">#è®¾å®šæ¯ä¸ªè¿›ç¨‹æ‰€èƒ½å¤Ÿæ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ï¼Œé»˜è®¤æƒ…å†µä¸‹å…¶ä¼šè‡ªåŠ¨è¿›è¡Œè®¡ç®—ï¼Œå› æ­¤ä¸å»ºè®®ä¿®æ”¹æ­¤é€‰é¡¹;</span></span><br><span class="line">node: <span class="hljs-comment">#å®šä¹‰å½“å‰èŠ‚ç‚¹çš„åç§°ï¼Œç”¨äºHAåœºæ™¯ä¸­å¤šhaproxyè¿›ç¨‹å…±äº«åŒä¸€ä¸ªIPåœ°å€æ—¶;</span></span><br><span class="line">description: <span class="hljs-comment">#å½“å‰å®ä¾‹çš„æè¿°ä¿¡æ¯;</span></span><br><span class="line">maxconn: <span class="hljs-comment">#è®¾å®šæ¯ä¸ªhaproxyè¿›ç¨‹æ‰€æ¥å—çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼Œå…¶ç­‰åŒäºå‘½ä»¤è¡Œé€‰é¡¹"-n"ï¼Œ"ulimit-n"è‡ªåŠ¨è®¡ç®—çš„ç»“æœæ­£å¼å‚ç…§ä»å‚æ•°è®¾å®šçš„;</span></span><br><span class="line">maxpipes: <span class="hljs-comment">#haproxyä½¿ç”¨pipeå®ŒæˆåŸºäºå†…æ ¸çš„tcpæŠ¥æ–‡é‡ç»„ï¼Œæ­¤é€‰é¡¹ç”¨äºè®¾å®šæ¯è¿›ç¨‹æ‰€å…è®¸ä½¿ç”¨çš„æœ€å¤§pipeä¸ªæ•°ï¼Œæ¯ä¸ªpipeä¼šæ‰“å¼€ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤ï¼Œ"ulimit -n"è‡ªåŠ¨è®¡ç®—çš„ç»“æœä¼šæ ¹æ®éœ€è¦è°ƒå¤§æ­¤å€¼ï¼Œé»˜è®¤ä¸ºmaxcoon/4;</span></span><br><span class="line">noepoll: <span class="hljs-comment">#åœ¨linuxç³»ç»Ÿä¸Šç¦ç”¨epollæœºåˆ¶;</span></span><br><span class="line">nokqueue: <span class="hljs-comment">#åœ¨BSEç³»ç»Ÿä¸Šç¦ç”¨kqueueæœºåˆ¶;</span></span><br><span class="line">nopoll: <span class="hljs-comment">#ç¦ç”¨pollæœºåˆ¶;</span></span><br><span class="line">nosepoll: <span class="hljs-comment">#åœ¨linuxç³»ç»Ÿä¸Šç¦ç”¨å¯å‘å¼epollæœºåˆ¶;</span></span><br><span class="line">nosplice: <span class="hljs-comment">#ç¦æ­¢åœ¨linuxå¥—æ¥å­—ä¸Šä½¿ç”¨tcpé‡ç»„ï¼Œè¿™ä¼šå¯¼è‡´æ›´å¤šçš„recv/sendè°ƒç”¨ï¼Œä¸è¿‡ï¼Œåœ¨linux2.6.25-28ç³»åˆ—çš„å†…æ ¸ä¸Šï¼Œtcpé‡ç»„åŠŸèƒ½æœ‰bugå­˜åœ¨;</span></span><br><span class="line">spread-checks<0..50,<span class="hljs-keyword">in</span> percent>: <span class="hljs-comment">#åœ¨haprorxyåç«¯æœ‰ç€ä¼—å¤šæœåŠ¡å™¨çš„åœºæ™¯ä¸­ï¼Œåœ¨ç´§ç¼ºæ˜¯æ—¶é—´é—´éš”åç»Ÿä¸€å¯¹ä¸­æœåŠ¡å™¨è¿›è¡Œå¥åº·çŠ¶å†µæ£€æŸ¥å¯èƒ½ä¼šå¸¦æ¥æ„å¤–é—®é¢˜ï¼Œæ­¤é€‰é¡¹ç”¨äºå°†æ£€æŸ¥çš„æ—¶é—´é—´éš”é•¿åº¦ä¸Šå¢åŠ æˆ–å‡å°‘ä¸€å®šçš„éšæœºæ—¶é•¿ï¼Œä¸ºå½“å‰æ£€æŸ¥æ£€æµ‹æ—¶é—´çš„%;</span></span><br><span class="line">maxconnrateï¼š<span class="hljs-comment">#è®¾ç½®æ¯ä¸ªè¿›ç¨‹æ¯ç§’ç§æ‰€èƒ½å»ºç«‹çš„æœ€å¤§è¿æ¥æ•°é‡ï¼Œé€Ÿç‡ï¼Œä¸€ä¸ªè¿æ¥é‡Œå¯ä»¥æœ‰å¤šä¸ªä¼šè¯ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ä¼šè¯</span></span><br><span class="line">maxsessrateï¼š<span class="hljs-comment">#è®¾ç½®æ¯ä¸ªè¿›ç¨‹æ¯ç§’ç§æ‰€èƒ½å»ºç«‹çš„æœ€å¤§ä¼šè¯æ•°é‡</span></span><br><span class="line">maxsslconnï¼š<span class="hljs-comment">#æ¯è¿›ç¨‹æ”¯æŒSSL çš„æœ€å¤§è¿æ¥æ•°é‡</span></span><br><span class="line">tune.bufsize: <span class="hljs-comment">#è®¾å®šbufferçš„å¤§å°ï¼ŒåŒæ ·çš„å†…å­˜æ¡ä»¶ä¸‹ï¼Œè¾ƒå°çš„å€¼å¯ä»¥è®©haproxyæœ‰èƒ½åŠ›æ¥å—æ›´å¤šçš„å¹¶å‘è¿æ¥ï¼Œè¾ƒå¤§çš„å€¼äº†å¯ä»¥è®©æŸäº›åº”ç”¨ç¨‹åºä½¿ç”¨è¾ƒå¤§çš„cookieä¿¡æ¯ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨é»˜è®¤å€¼;</span></span><br><span class="line">tune.chksize: <span class="hljs-comment">#è®¾å®šæ£€æŸ¥ç¼“å†²åŒºçš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œæ›´å¤§çš„å€¼æœ‰åŠ©äºåœ¨è¾ƒå¤§çš„é¡µé¢ä¸­å®ŒæˆåŸºäºå­—ç¬¦ä¸²æˆ–æ¨¡å¼çš„æ–‡æœ¬æŸ¥æ‰¾ï¼Œä½†ä¹Ÿä¼šå ç”¨æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œä¸å»ºè®®ä¿®æ”¹;</span></span><br><span class="line">tune.maxaccept: <span class="hljs-comment">#è®¾å®šhaproxyè¿›ç¨‹å†…æ ¸è°ƒåº¦è¿è¡Œæ—¶ä¸€æ¬¡æ€§å¯ä»¥æ¥å—çš„è¿æ¥çš„ä¸ªæ•°ï¼Œè¾ƒå¤§çš„å€¼å¯ä»¥å¸¦æ¥è¾ƒå¤§çš„ååé‡ã€‚</span></span><br><span class="line">tune.maxpollevents: <span class="hljs-comment">#è®¾å®šä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å¯ä»¥å¤„ç†çš„äº‹ä»¶æœ€å¤§æ•°ï¼Œé»˜è®¤å€¼å–å†³äºOS,å…¶è‡³å°äº200æ—¶å¯ä»‹äºå¸¦å®½ï¼Œä½†ä¼šç•¥å¾®å¢å¤§ç½‘ç»œå»¶è¿Ÿï¼Œä½†å¤§äº200æ—¶ä¼šé™ä½å»¶è¿Ÿï¼Œä½†ä¼šç¨ç¨å¢åŠ ç½‘ç»œå¸¦å®½çš„å ç”¨;</span></span><br><span class="line">tune.maxrewrite: <span class="hljs-comment">#è®¾å®šåœ¨é¦–éƒ¨é‡å†™æˆ–è¿½åŠ è€Œé¢„ç•™çš„ç¼“å­˜ç©ºé—´ï¼Œå»ºè®®ä½¿ç”¨1024å·¦å³çš„å¤§å°ï¼Œåœ¨éœ€è¦æ›´å¤§çš„ç©ºé—´æ—¶ï¼Œhaproxyä¼šè‡ªåŠ¨å¢åŠ å…¶å€¼;</span></span><br><span class="line">tune.rcvbuf.client: <span class="hljs-comment">#è®¾å®šå†…æ ¸å¥—æ¥å­—ä¸­å®¢æˆ·ç«¯æ¥æ”¶ç¼“å­˜åŒºçš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨é»˜è®¤å€¼;</span></span><br><span class="line">tune.rcvbuf.server: <span class="hljs-comment">#è®¾å®šå†…æ ¸å¥—æ¥å­—ä¸­æœåŠ¡å™¨æ¥æ”¶ç¼“å­˜åŒºçš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨é»˜è®¤å€¼;</span></span><br><span class="line">tune.sndbuf.client: <span class="hljs-comment">#è®¾å®šå†…æ ¸å¥—æ¥å­—ä¸­å®¢æˆ·ç«¯å‘é€ç¼“å­˜åŒºçš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨é»˜è®¤å€¼;</span></span><br><span class="line">tune.sndbuf.server: <span class="hljs-comment">#è®¾å®šå†…æ ¸å¥—æ¥å­—ä¸­æœåŠ¡å™¨ç«¯å‘é€ç¼“å­˜åŒºçš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨é»˜è®¤å€¼;</span></span><br><span class="line">debug: <span class="hljs-comment">#è°ƒè¯•æ¨¡å¼ï¼Œè¾“å‡ºå¯åŠ¨ä¿¡æ¯åˆ°æ ‡å‡†è¾“å‡º;</span></span><br><span class="line">quiet: <span class="hljs-comment">#å®‰è£…æ¨¡å¼ï¼Œå¯åŠ¨æ—¶æ— è¾“å‡º;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>globalé»˜è®¤é…ç½®</strong></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># å…¨å±€é…ç½®</span></span><br><span class="line">global</span><br><span class="line">    <span class="hljs-built_in">log</span> 127.0.0.1 local0         <span class="hljs-comment"># è®¾ç½®æ—¥å¿—</span></span><br><span class="line">    <span class="hljs-built_in">log</span> 127.0.0.1 local1 notice</span><br><span class="line">    maxconn 4000                 <span class="hljs-comment"># æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">    chroot /usr/<span class="hljs-built_in">local</span>/haproxy    <span class="hljs-comment"># å®‰è£…ç›®å½•</span></span><br><span class="line">    user haproxy</span><br><span class="line">    group haproxy</span><br><span class="line">    daemon                       <span class="hljs-comment"># å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ</span></span><br><span class="line">    <span class="hljs-comment">#nbproc 1                    # è¿›ç¨‹æ•°é‡ï¼Œåªèƒ½ç”¨äºå®ˆæŠ¤è¿›ç¨‹æ¨¡å¼çš„haproxyï¼›é»˜è®¤å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€èˆ¬åªåœ¨å•è¿›ç¨‹ä»…èƒ½æ‰“å¼€å°‘æ•°æ–‡ä»¶æè¿°ç¬¦çš„åœºæ™¯ä¸­æ‰ä½¿ç”¨å¤šè¿›ç¨‹æ¨¡å¼ï¼›</span></span><br><span class="line">    pidfile /var/run/haproxy.pid <span class="hljs-comment"># pidæ–‡ä»¶çš„å­˜æ”¾ä½ç½®</span></span><br></pre></td></tr></tbody></table></figure>


<p><strong>defaultsé»˜è®¤é…ç½®</strong></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">defaults</span><br><span class="line">ã€€ã€€mode http   <span class="hljs-comment">#é»˜è®¤è´Ÿè½½å‡è¡¡æ¨¡å¼ä¸ºhttp</span></span><br><span class="line">ã€€ã€€<span class="hljs-built_in">log</span> global    <span class="hljs-comment">#æ—¥å¿—å®šä¹‰</span></span><br><span class="line">ã€€ã€€option httplog   <span class="hljs-comment">#å¯ç”¨æ—¥å¿—è®°å½•HTTPè¯·æ±‚ï¼Œé»˜è®¤ä¸è®°å½•http log</span></span><br><span class="line">ã€€ã€€option dontlognull   <span class="hljs-comment">#ä¸è®°å½•ç©ºæ—¥å¿—</span></span><br><span class="line">ã€€ã€€option httpclose   <span class="hljs-comment"># æ¯æ¬¡è¯·æ±‚å®Œæ¯•åä¸»åŠ¨å…³é—­httpé€šé“</span></span><br><span class="line">ã€€ã€€option forwardfor  except 127.0.0.0/8 <span class="hljs-comment">#æ’å…¥x-forwardæ ‡è®°ï¼Œåå‘ä»£ç†æ—¶å€™å¯ä»¥é€šè¿‡è¯¥å­—æ®µè·å–å®¢æˆ·ç«¯çœŸå®IP</span></span><br><span class="line">   balance roundrobin <span class="hljs-comment"># è´Ÿè½½å‡è¡¡ç®—æ³•,è½®è¯¢</span></span><br><span class="line">ã€€ã€€retries 3   <span class="hljs-comment"># å®šä¹‰è¿æ¥åç«¯æœåŠ¡å™¨çš„å¤±è´¥é‡è¿æ¬¡æ•°</span></span><br><span class="line">ã€€ã€€timeout http-request 10sï¼š<span class="hljs-comment">#åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ä½†ä¸è¯·æ±‚æ•°æ®æ—¶ï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">   timeout queue 1m : <span class="hljs-comment">#æœåŠ¡å™¨çš„maxconnæ—¶ï¼Œè¿æ¥åœ¨é˜Ÿåˆ—ä¸­ä¿æŒæŒ‚èµ·çŠ¶æ€è€Œè®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œæƒ³å®¢æˆ·ç«¯è¿”å›503é”™è¯¯</span></span><br><span class="line">   timeout connect 10sï¼š <span class="hljs-comment">#å®šä¹‰haproxyå°†å®¢æˆ·ç«¯è¯·æ±‚è½¬å‘è‡³åç«¯æœåŠ¡å™¨æ‰€ç­‰å¾…çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout client 1mï¼š<span class="hljs-comment">#å®¢æˆ·ç«¯éæ´»åŠ¨çŠ¶æ€çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout server 1mï¼š<span class="hljs-comment">#å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å»ºç«‹è¿æ¥åï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout http-keep-alive 10s: <span class="hljs-comment">#å®šä¹‰ä¿æŒè¿æ¥çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout check           10s: <span class="hljs-comment">#å¥åº·çŠ¶æ€ç›‘æµ‹æ—¶çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡çŸ­ä¼šè¯¯åˆ¤ï¼Œè¿‡é•¿èµ„æºæ¶ˆè€—</span></span><br><span class="line">   maxconn                 3000: <span class="hljs-comment">#æ¯ä¸ªserveræœ€å¤§çš„è¿æ¥æ•° </span></span><br><span class="line"></span><br><span class="line">   <span class="hljs-comment"># è¶…æ—¶å‚æ•°</span></span><br><span class="line">   timeout http request ï¼š<span class="hljs-comment">#åœ¨å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ä½†ä¸è¯·æ±‚æ•°æ®æ—¶ï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">   timeout queue ï¼š<span class="hljs-comment">#ç­‰å¾…æœ€å¤§æ—¶é•¿</span></span><br><span class="line">   timeout connectï¼š <span class="hljs-comment">#å®šä¹‰haproxyå°†å®¢æˆ·ç«¯è¯·æ±‚è½¬å‘è‡³åç«¯æœåŠ¡å™¨æ‰€ç­‰å¾…çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout clientï¼š<span class="hljs-comment">#å®¢æˆ·ç«¯éæ´»åŠ¨çŠ¶æ€çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout serverï¼š<span class="hljs-comment">#å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å»ºç«‹è¿æ¥åï¼Œç­‰å¾…æœåŠ¡å™¨ç«¯çš„è¶…æ—¶æ—¶é•¿ï¼Œ</span></span><br><span class="line">   timeout http-keep-alive ï¼š<span class="hljs-comment">#å®šä¹‰ä¿æŒè¿æ¥çš„è¶…æ—¶æ—¶é•¿</span></span><br><span class="line">   timeout checkï¼š<span class="hljs-comment">#å¥åº·çŠ¶æ€ç›‘æµ‹æ—¶çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡çŸ­ä¼šè¯¯åˆ¤ï¼Œè¿‡é•¿èµ„æºæ¶ˆè€—</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>listené»˜è®¤é…ç½®</strong></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># ç›‘å¬é¡µé¢é…ç½®</span></span><br><span class="line">listen admin_stats  </span><br><span class="line">    <span class="hljs-built_in">bind</span> 0.0.0.0:50000           <span class="hljs-comment"># ç›‘å¬IPå’Œç«¯å£ï¼Œä¸ºäº†å®‰å…¨å¯ä»¥è®¾ç½®æœ¬æœºçš„å±€åŸŸç½‘IPåŠç«¯å£ï¼›</span></span><br><span class="line">    mode http</span><br><span class="line">    option httplog               <span class="hljs-comment"># é‡‡ç”¨httpæ—¥å¿—æ ¼å¼  </span></span><br><span class="line">    stats refresh 30s            <span class="hljs-comment"># ç»Ÿè®¡é¡µé¢è‡ªåŠ¨åˆ·æ–°æ—¶é—´ </span></span><br><span class="line">    stats <span class="hljs-built_in">enable</span>                 <span class="hljs-comment"># å¯ç”¨çŠ¶æ€ç»Ÿè®¡æŠ¥å‘Š</span></span><br><span class="line">    stats uri /stats    <span class="hljs-comment"># çŠ¶æ€ç®¡ç†é¡µé¢ï¼Œé€šè¿‡ ip+port/statsæ¥è®¿é—®  å¦‚10.0.5.92:9999/stats</span></span><br><span class="line"></span><br><span class="line">    stats realm <span class="hljs-string">"LOGIN"</span>  <span class="hljs-comment"># å¯†ç æ¡†ä¸Šæ˜¾ç¤ºçš„æ–‡æœ¬</span></span><br><span class="line">    stats auth admin:psadmin     <span class="hljs-comment"># ç»Ÿè®¡é¡µé¢ç”¨æˆ·åå’Œå¯†ç è®¾ç½®  </span></span><br><span class="line">    stats hide-version          <span class="hljs-comment"># éšè—ç»Ÿè®¡é¡µé¢ä¸ŠHAProxyçš„ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">    <span class="hljs-comment">#errorfile 403 /usr/local/haproxy/examples/errorfiles/   #è®¾ç½®haproxy é”™è¯¯é¡µé¢ </span></span><br><span class="line">    stats admin_stats <span class="hljs-keyword">if</span> TRUE <span class="hljs-comment">#å¦‚æœè®¤è¯é€šè¿‡å°±åšç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥ç®¡ç†åç«¯çš„æœåŠ¡å™¨</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>å‰ç«¯é…ç½®</strong></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">frontend http_main</span><br><span class="line">    <span class="hljs-built_in">bind</span> 0.0.0.0:80              <span class="hljs-comment"># httpè¯·æ±‚çš„ç«¯å£ï¼Œä¼šè¢«è½¬å‘åˆ°è®¾ç½®çš„ipåŠç«¯å£</span></span><br><span class="line">    <span class="hljs-comment"># bind :80 # ç›‘å¬æœ¬æœºæ‰€æœ‰ip80ç«¯å£</span></span><br><span class="line">    <span class="hljs-comment"># bind *:80</span></span><br><span class="line">    <span class="hljs-comment"># bind 192.168.12.1:8080,10.1.0.12:8090</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment"># è½¬å‘è§„åˆ™</span></span><br><span class="line">    <span class="hljs-comment">#acl url_yuming   path_beg www.yuming.com</span></span><br><span class="line">    <span class="hljs-comment">#use_backend server_yuming if url_yuming</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># é»˜è®¤è·³è½¬é¡¹ï¼Œå½“ä¸Šé¢éƒ½æ²¡æœ‰åŒ¹é…ä¸Šï¼Œå°±è½¬åˆ°backendçš„http_defaultä¸Šï¼›</span></span><br><span class="line">    default_backend http_default</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># æå‡å¤±è´¥çš„æ—¶å€™çš„ç”¨æˆ·ä½“éªŒ</span></span><br><span class="line">    <span class="hljs-comment">#errorfile 502 /usr/local/haproxy/examples/errorfiles/502.http</span></span><br><span class="line">    <span class="hljs-comment">#errorfile 503 /usr/local/haproxy/examples/errorfiles/503.http</span></span><br><span class="line">    <span class="hljs-comment">#errorfile 504 /usr/local/haproxy/examples/errorfiles/504.http</span></span><br></pre></td></tr></tbody></table></figure>


<p><strong>åç«¯é…ç½®</strong></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">backend http_default</span><br><span class="line">    <span class="hljs-comment"># é¢å¤–çš„ä¸€äº›è®¾ç½®ï¼ŒæŒ‰éœ€ä½¿ç”¨</span></span><br><span class="line">    option forwardfor</span><br><span class="line">    option forwardfor header Client-IP</span><br><span class="line">    option http-server-close</span><br><span class="line">    option httpclose</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># è´Ÿè½½å‡è¡¡æ–¹å¼</span></span><br><span class="line">    <span class="hljs-comment">#source æ ¹æ®è¯·æ±‚æºIP</span></span><br><span class="line">    <span class="hljs-comment">#static-rr æ ¹æ®æƒé‡</span></span><br><span class="line">    <span class="hljs-comment">#leastconn æœ€å°‘è¿æ¥å…ˆå¤„ç†;åœ¨æœ‰ç€è¾ƒé•¿æ—¶é—´ä¼šè¯çš„åœºæ™¯ä¸­æ¨èä½¿ç”¨æ­¤ç®—æ³•ï¼Œå¦‚LDAPã€SQLç­‰ï¼Œå…¶å¹¶ä¸å¤ªé€‚ç”¨äºè¾ƒçŸ­ä¼šè¯çš„åº”ç”¨å±‚åè®®ï¼Œå¦‚HTTPï¼›æ­¤ç®—æ³•æ˜¯åŠ¨æ€çš„ï¼Œ</span></span><br><span class="line">    <span class="hljs-comment">#uri æ ¹æ®è¯·æ±‚çš„uri</span></span><br><span class="line">    <span class="hljs-comment">#url_param æ ¹æ®è¯·æ±‚çš„urlå‚æ•°</span></span><br><span class="line">    <span class="hljs-comment">#rdp-cookie æ®æ®cookie(name)æ¥é”å®šå¹¶å“ˆå¸Œæ¯ä¸€æ¬¡è¯·æ±‚</span></span><br><span class="line">    <span class="hljs-comment">#hdr(name) æ ¹æ®HTTPè¯·æ±‚å¤´æ¥é”å®šæ¯ä¸€æ¬¡HTTPè¯·æ±‚</span></span><br><span class="line">    <span class="hljs-comment">#roundrobin è½®è¯¢æ–¹å¼</span></span><br><span class="line">    balance roundrobin           <span class="hljs-comment"># è´Ÿè½½å‡è¡¡çš„æ–¹å¼,è½®è¯¢æ–¹å¼</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># è®¾ç½®å¥åº·æ£€æŸ¥é¡µé¢</span></span><br><span class="line">    <span class="hljs-comment">#option httpchk GET /index.html</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">#ä¼ é€’å®¢æˆ·ç«¯çœŸå®IP</span></span><br><span class="line">    option forwardfor header X-Forwarded-For</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># éœ€è¦è½¬å‘çš„ipåŠç«¯å£</span></span><br><span class="line">    <span class="hljs-comment"># inter 2000 å¥åº·æ£€æŸ¥æ—¶é—´é—´éš”2ç§’</span></span><br><span class="line">    <span class="hljs-comment"># rise 3 æ£€æµ‹å¤šå°‘æ¬¡æ‰è®¤ä¸ºæ˜¯æ­£å¸¸çš„</span></span><br><span class="line">    <span class="hljs-comment"># fall 3 å¤±è´¥å¤šå°‘æ¬¡æ‰è®¤ä¸ºæ˜¯ä¸å¯ç”¨çš„</span></span><br><span class="line">    <span class="hljs-comment"># weight 30 æƒé‡</span></span><br><span class="line">    server node1 192.168.1.101:8080 check inter 2000 rise 3 fall 3 weight 30</span><br><span class="line">    server node2 192.168.1.101:8081 check inter 2000 rise 3 fall 3 weight 30</span><br></pre></td></tr></tbody></table></figure>


<p><strong>å¸¸ç”¨å‚æ•°</strong><br>bind ç”¨äºç›‘å¬</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">bind</span> [<address>]:<port_range> [,...] [param*] </span><br><span class="line"><span class="hljs-comment"># ä»…åœ¨frontendå’ŒlistenåŒºåŸŸä½¿ç”¨</span></span><br><span class="line"><span class="hljs-built_in">bind</span> 0.0.0.0:80              <span class="hljs-comment"># httpè¯·æ±‚çš„ç«¯å£ï¼Œä¼šè¢«è½¬å‘åˆ°è®¾ç½®çš„ipåŠç«¯å£</span></span><br><span class="line">    <span class="hljs-comment"># bind :80 # ç›‘å¬æœ¬æœºæ‰€æœ‰ip80ç«¯å£</span></span><br><span class="line">    <span class="hljs-comment"># bind *:80</span></span><br><span class="line">    <span class="hljs-comment"># bind 192.168.12.1:8080,10.1.0.12:8090</span></span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2 id="å•å°haproxy-ä¸¤å°RSæœåŠ¡å™¨"><a href="#å•å°haproxy-ä¸¤å°RSæœåŠ¡å™¨" class="headerlink" title="å•å°haproxy+ä¸¤å°RSæœåŠ¡å™¨"></a>å•å°haproxy+ä¸¤å°RSæœåŠ¡å™¨</h2><p>é…ç½®<br>haproxy æœåŠ¡å™¨ 10.0.5.93<br>RS æœåŠ¡å™¨1  10.0.5.90<br>RS æœåŠ¡å™¨2  10.0.5.91</p>
<p>åˆå§‹åŒ–å‡†å¤‡<br>å¦‚æœå¯¹é˜²ç«å¢™æ²¡æœ‰å¤ªå¤§çš„è¦æ±‚ï¼Œå¯ä»¥ç›´æ¥å…³é—­é˜²æŠ¤å¢™ æ‰€æœ‰æœºå™¨éƒ½å…³é—­</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl status firewalld</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># å®‰è£…haproxy</span></span><br><span class="line">yum install haproxy -y</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># é…ç½®</span></span><br><span class="line">vi /etc/haproxy/haproxy.cfg</span><br></pre></td></tr></tbody></table></figure>

<p>haproxyæœåŠ¡å™¨ DS</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># åŸºç¡€é…ç½®</span></span><br><span class="line">global</span><br><span class="line">    <span class="hljs-built_in">log</span>         127.0.0.1 local0</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    <span class="hljs-built_in">log</span>                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    balance roundrobin                      </span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000 </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># å¼€å¯ç›‘å¬ç«¯å£</span></span><br><span class="line">listen Status                   <span class="hljs-comment"># åå­—éšä¾¿ç”¨</span></span><br><span class="line">  <span class="hljs-built_in">bind</span> 10.0.5.93:9999           <span class="hljs-comment"># ç»‘å®šç›‘å¬ç«¯å£</span></span><br><span class="line">  mode http                     </span><br><span class="line">  stats <span class="hljs-built_in">enable</span></span><br><span class="line">  stats uri /stats</span><br><span class="line">  stats realm <span class="hljs-string">"LOGIN"</span></span><br><span class="line">  stats refresh 6s</span><br><span class="line">  stats auth upyun:upyun123</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># ç«¯å£è½¬å‘</span></span><br><span class="line">listen web_server               <span class="hljs-comment"># åå­—éšä¾¿ç”¨</span></span><br><span class="line">  mode tcp                  <span class="hljs-comment">#é‡‡ç”¨7å±‚æ¨¡å¼</span></span><br><span class="line">  <span class="hljs-built_in">bind</span> *:7777                   <span class="hljs-comment"># è½¬å‘ç«¯å£ è¯·æ±‚7777 -> RS:8888 ä¸Šé¢  å› æ­¤è¿™é‡Œçš„*:7777 å¯åšvip -> keepalive</span></span><br><span class="line">  balance roundrobin         <span class="hljs-comment">#è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œè¿™é‡Œæ˜¯è½®æ¢ # è½®è¯¢ç®—æ³•</span></span><br><span class="line">  <span class="hljs-comment">#option httpchk GET /test.test #å¥åº·æ£€æµ‹   # å¥åº·æ£€æµ‹</span></span><br><span class="line">  server web1 10.0.5.91:8888 weight 3 check inter 500 fall 3</span><br><span class="line">  server web2 10.0.5.90:8888 weight 2 check inter 500 fall 3</span><br></pre></td></tr></tbody></table></figure>

<p>æŸ¥çœ‹haproxy  ç›‘å¬ç«¯çŠ¶æ€<br><img src="http://img.noback.top/2020-01-10-15-46-07.png" alt="2020-01-10-15-46-07"><br>ä¸æ–­è¯·æ±‚10.0.5.93:7777 ä¼šå‘ç°ipä¼šåœ¨90 ä¸91 ä¹‹é—´ä¸æ–­æ”¹å˜ï¼Œå› ä¸ºæˆ‘ä»¬é‡‡ç”¨äº†è½®è¯¢çš„æœºåˆ¶ï¼Œç›¸åº”çš„å›¾ä¸­web totalä¹Ÿä¼šä¸æ–­å¢åŠ </p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">while</span> 1; <span class="hljs-keyword">do</span> curl http://10.0.5.93:7777/|grep <span class="hljs-string">"< h2 >.*< /h2 >"</span> ;sleep 1; <span class="hljs-keyword">done</span></span><br></pre></td></tr></tbody></table></figure>
<p>over</p>
<h2 id="keepalive-haproxy"><a href="#keepalive-haproxy" class="headerlink" title="keepalive+haproxy"></a>keepalive+haproxy</h2><p>å°±æ˜¯åœ¨ä¸Šé¢çš„å•å°haproxyæœºå™¨ä¸Š  æ·»åŠ ä¸€å°haproxyæœºå™¨ï¼ŒåŒæ—¶åˆ©ç”¨keepalivedçš„ç‰¹æ€§ï¼Œä½¿ç”¨vipåœ¨ä¸¤å°haproxyæœºå™¨ä¸Šæ¼‚ç§»ï¼Œæ— è®ºvipæ¼‚ç§»åˆ°å“ªä¸ªåœ°æ–¹ï¼Œéƒ½æœ‰å¯¹åº”çš„haproxyæœºå™¨å»å¯¹ä¸‹é¢çš„ä¸¤å°RSæœºå™¨è¿›è¡Œè´Ÿè½½å‡è¡¡</p>
<p>keepalive æé«˜ haproxyçš„ç¨³å®šæ€§<br>haproxy æé«˜ RSçš„ç¨³å®šæ€§</p>
<p>é…ç½®<br>DS1   keepalive + haproxy  10.0.5.93<br>DS2   keepalive + haproxy  10.0.5.92</p>
<p>RS1   10.0.5.91<br>RS2   10.0.5.90 </p>
<p>VIP   10.0.5.96<br>ç›‘æ§ç«¯å£  10.0.5.96:9999/stats<br>VIPç«¯å£ 10.0.5.96:8888 â€”- >  10.0.5.91:8888</p>
<p>DS1 keepaliveé…ç½®</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># å£°æ˜ä¸€ä¸‹èº«ä»½å’Œvipå°±é†’äº†</span></span><br><span class="line">! Configuration File <span class="hljs-keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eno1</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 1000</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        10.0.5.96/20</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>DS2 keepalivedé…ç½®</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">! Configuration File <span class="hljs-keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eno1</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 10</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        10.0.5.96/20</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™æ—¶å€™ä½ å¯ä»¥å…ˆæµ‹è¯•ä¸€ä¸‹keepalivedæ˜¯å¦æˆåŠŸï¼Œä¸¤è¾¹å¼€èµ·æ¥ï¼Œç„¶åå…³æ‰DS-masteræœºå™¨ï¼Œå¦‚æœVIPæ¼‚ç§»åˆ°DS-BACKUPä¸Šé¢åˆ™è¡¨ç¤ºæˆåŠŸ</p>
<p>DS1 haproxyé…ç½®   ä¸  DS2 haproxyç›¸åŒ</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">global</span><br><span class="line">    <span class="hljs-built_in">log</span>         127.0.0.1 local0</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    <span class="hljs-built_in">log</span>                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    balance roundrobin</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># ç›‘å¬ç«¯å£</span></span><br><span class="line">listen Status</span><br><span class="line">  <span class="hljs-built_in">bind</span> 10.0.5.96:9999</span><br><span class="line">  mode http</span><br><span class="line">  stats <span class="hljs-built_in">enable</span></span><br><span class="line">  stats uri /stats</span><br><span class="line">  stats realm <span class="hljs-string">"LOGIN"</span></span><br><span class="line">  stats refresh 6s</span><br><span class="line">  stats auth upyun:upyun123</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># è¿™ä¸ª80ç«¯å£æœ‰ä»€ä¹ˆç”¨</span></span><br><span class="line">listen web_server</span><br><span class="line">  mode tcp                  <span class="hljs-comment">#é‡‡ç”¨7å±‚æ¨¡å¼</span></span><br><span class="line">  <span class="hljs-built_in">bind</span> *:7777</span><br><span class="line">  balance roundrobin         <span class="hljs-comment">#è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œè¿™é‡Œæ˜¯è½®æ¢</span></span><br><span class="line">  <span class="hljs-comment">#option httpchk GET /test.test #å¥åº·æ£€æµ‹</span></span><br><span class="line">  server web1 10.0.5.91:8888 weight 3 check inter 500 fall 3</span><br><span class="line">  server web2 10.0.5.90:8888 weight 2 check inter 500 fall 3</span><br></pre></td></tr></tbody></table></figure>

<p>RSæœºå™¨å°†VIPå†™å…¥å›æºåœ°å€</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">ifconfig enp4s0:0 10.0.5.96 broadcast 10.0.5.96 netmask 255.255.240.0 up</span><br></pre></td></tr></tbody></table></figure>

<p>å¦å¤–ï¼Œå½“æˆ‘åˆ‡æ–­master-keepalivedçš„æ˜¯å¦ï¼Œä¼šæœ‰ä¸€å®šæ—¶é—´çš„å»¶è¿Ÿ<br><img src="http://img.noback.top/2020-01-10-17-44-01.png" alt="2020-01-10-17-44-01"></p>
</body></html>
        </div>
        
            <ul class="post-copyright">
            <li><strong>æœ¬æ–‡æ ‡é¢˜ï¼š</strong><a href="http://blog.noback.top/posts/14c89e63/">keepalive+haproxyè´Ÿè½½å‡è¡¡</a></li>
            <li><strong>æœ¬æ–‡ä½œè€…ï¼š</strong><a href="http://blog.noback.top">ä½•æ³½å›</a></li>
            <li><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://blog.noback.top/posts/14c89e63/">http://blog.noback.top/posts/14c89e63/</a></li>
            <li><strong>å‘å¸ƒæ—¶é—´ï¼š</strong>2020-01-07</li>
            <li><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
            </li>
            </ul>
        
        
        <hr style="height:1px;margin:1rem 0"/>
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <i class="fas fa-tags has-text-grey"></i>&nbsp;
                    <a class="has-link-grey -link" href="/tags/linux/" rel="tag">linux</a>,&nbsp;<a class="has-link-grey -link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">è´Ÿè½½å‡è¡¡</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/posts/82cf9f4/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">ipv6éƒ¨ç½²</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/posts/d0a69eae/">
                <span class="level-item">shellè„šæœ¬</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">è¯„è®º</h3>
        
<script>
    var disqus_config = function () {
        this.page.url = 'http://blog.noback.top/posts/14c89e63/';
        this.page.identifier = 'posts/14c89e63/';
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'alphalxy-blog' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
    </div>
</div>

</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level" style="margin-bottom:1rem">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-96x96 has-mb-6" src="http://image.noback.top/dataheader.jpeg" alt="">
                    
                    
                    
                    <p class="is-size-6 is-block">
                        hzj
                    </p>
                    
                    
                </div>
            </div>
        </nav>
        <nav class="level menu-list is-mobile" style="margin-bottom:1rem">
            <div class="level-item has-text-centered is-marginless">
                <a href="/archives/">
                    <p class="heading">
                        æ–‡ç« 
                    </p>
                    <p class="title has-text-weight-normal">
                        114
                    </p>
                </a>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <a href="/categories/">
                    <p class="heading">
                        åˆ†ç±»
                    </p>
                    <p class="title has-text-weight-normal">
                        28
                    </p>
                </a>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <a href="/tags/">
                    <p class="heading">
                        æ ‡ç­¾
                    </p>
                    <p class="title has-text-weight-normal">
                        19
                    </p>
                </a>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="/" target="_blank">
                <i class="fab fa-github"></i>&nbsp;&nbsp;å…³æ³¨æˆ‘</a>
        </div>
        
        
    </div>
</div>

    
        
<div class="card widget column-left is-sticky"   style="max-height: 900px; overflow: auto;" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                ç›®å½•
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#haproxyè´Ÿè½½å‡è¡¡">
        <span class="has-mr-6">1</span>
        <span>haproxyè´Ÿè½½å‡è¡¡</span>
        </a></li><li>
        <a class="is-flex" href="#å•å°haproxy-ä¸¤å°RSæœåŠ¡å™¨">
        <span class="has-mr-6">2</span>
        <span>å•å°haproxy+ä¸¤å°RSæœåŠ¡å™¨</span>
        </a></li><li>
        <a class="is-flex" href="#keepalive-haproxy">
        <span class="has-mr-6">3</span>
        <span>keepalive+haproxy</span>
        </a></li></ul>
        </div>
    </div>
</div>


    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>


                

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="http://image.noback.top/datadog.svg" alt="keepalive+haproxyè´Ÿè½½å‡è¡¡" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 ä½•æ³½å›&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                <br>
                <span id="busuanzi_container_site_uv">
                å…±<span id="busuanzi_value_site_uv">0</span>ä¸ªè®¿å®¢
                </span>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                        
                        <i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-nc"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i>&nbsp;
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="AlphaLxy GitHub" href="https://www.github.com/AlphaLxy">
                        
                        <i class="fab fa-github"></i>&nbsp;
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'æ–‡ç« ',
                PAGES: 'é¡µé¢',
                CATEGORIES: 'åˆ†ç±»',
                TAGS: 'æ ‡ç­¾',
                UNTITLED: '(æ— æ ‡é¢˜)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>
