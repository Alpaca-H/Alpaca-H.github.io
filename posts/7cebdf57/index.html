<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>docker-k8s - Alpaca&#39;s blog | how to win</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="learn docker 🐳🕸️">
<meta property="og:type" content="article">
<meta property="og:title" content="docker-k8s">
<meta property="og:url" content="http://blog.noback.top/posts/7cebdf57/index.html">
<meta property="og:site_name" content="Alpaca&#39;s blog | how to win">
<meta property="og:description" content="learn docker 🐳🕸️">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.noback.top/images/og_image.png">
<meta property="article:published_time" content="2020-02-09T19:55:11.000Z">
<meta property="article:modified_time" content="2020-02-09T19:55:11.000Z">
<meta property="article:author" content="何泽君">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.noback.top/images/og_image.png">







<link rel="icon" href="/images/datadog.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/androidstudio.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    

    


<link rel="stylesheet" href="/css/style.css">
<meta name="generator" content="Hexo 4.2.0"></head>
<body class="is-3-column" background="http://img.noback.top/background.jpg">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="http://image.noback.top/datadog.svg" alt="docker-k8s" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/rust/">rust🦀️</a>
                
                <a class="navbar-item"
                href="/archives/">Archives</a>
                
                <a class="navbar-item"
                href="/categories/">Categories</a>
                
                <a class="navbar-item"
                href="/tags/">Tags</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="AlphaLxy GitHub" href="https://github.com/Alpaca-H/o">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-10-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <i class="fas fa-angle-double-right"></i>docker-k8s
            
        </h1>
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-02-09T19:55:11.000Z"><i class="far fa-calendar-alt">&nbsp;</i>2020-02-10</time>
                
                
                <div class="level-item">
                <i class="far fa-folder-open has-text-grey"></i>&nbsp;
                <a class="has-link-grey -link" href="/categories/linux/">linux</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/linux/docker/">docker</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    <i class="far fa-clock"></i>&nbsp;
                    
                    
                    15 分钟 读完 (大约 2286 个字)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>次访问
                </span>
                
            </div>
        </div>
        
        <div class="content">
            <html><head></head><body><p>learn docker 🐳🕸️</p>
<a id="more"></a>

<h1 id="docker-k8s"><a href="#docker-k8s" class="headerlink" title="docker-k8s"></a>docker-k8s</h1><h2 id="安装k8s及其管理工具"><a href="#安装k8s及其管理工具" class="headerlink" title="安装k8s及其管理工具"></a>安装k8s及其管理工具</h2><p>一些需要准备的环境</p>
<ul>
<li>关闭防火墙<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="hljs-built_in">disable</span> firewalld</span><br></pre></td></tr></tbody></table></figure></li>
<li>禁用selinux<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="hljs-string">'s/SELINUX=permissive/SELINUX=disabled/'</span> /etc/sysconfig/selinux</span><br></pre></td></tr></tbody></table></figure></li>
<li>关闭swap<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line"><span class="hljs-built_in">echo</span> <span class="hljs-string">"vm.swappiness = 0"</span>>> /etc/sysctl.conf</span><br></pre></td></tr></tbody></table></figure>
安装k8s <figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 国外镜像</span></span><br><span class="line"><span class="hljs-comment"># 这里的eof会被屏蔽掉所以我在这里加了注释。让他能够完整的显示</span></span><br><span class="line"><span class="hljs-comment"># cat << EOF > /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg</span><br><span class="line">        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 国内镜像</span></span><br><span class="line"><span class="hljs-comment"># cat <<EOF > /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 测试安装地址是否可以使用</span></span><br><span class="line">curl https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 安装</span></span><br><span class="line">yum makecache fast</span><br><span class="line">yum install -y kubelet kubeadm kubectl</span><br></pre></td></tr></tbody></table></figure>

</li>
</ul>
<h2 id="k8s单节点环境-minikube"><a href="#k8s单节点环境-minikube" class="headerlink" title="k8s单节点环境 minikube"></a>k8s单节点环境 minikube</h2><ol>
<li>检查Linux是否支持虚拟化<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">grep -E --color <span class="hljs-string">'vmx|svm'</span> /proc/cpuinfo</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 有两种情况</span></span><br><span class="line"><span class="hljs-comment"># 如果不支持虚拟化则显示为空</span></span><br><span class="line"><span class="hljs-comment"># 如果支持虚拟化则会显示具体内容，如下</span></span><br><span class="line">[root@work196 ~]<span class="hljs-comment"># grep -E --color 'vmx|svm' /proc/cpuinfo</span></span><br><span class="line">flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmo</span><br><span class="line">n pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl  ------> here   ----->  vmx <------- smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic movbe popcnt tsc</span><br><span class="line">_deadline_timer aes xsave avx f16c rdrand lahf_lm abm epb invpcid_single ssbd ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveo</span><br><span class="line">pt dtherm ida arat pln pts md_clear spec_ctrl intel_stibp flush_l1d</span><br></pre></td></tr></tbody></table></figure></li>
<li>在linux上直接安装minikube<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \</span><br><span class="line">  && chmod +x minikube</span><br></pre></td></tr></tbody></table></figure></li>
<li>启动minikube创建一个k8s单节点集群<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">minikube start <span class="hljs-comment"># 这里可能会出现一个问题， 没有指定虚拟机，</span></span><br><span class="line">[root@ops ~]<span class="hljs-comment"># minikube start</span></span><br><span class="line">😄  minikube v1.7.3 on Centos 7.2.1511</span><br><span class="line">💣  Unable to determine a default driver to use. Try specifying --vm-driver, or see https://minikube.sigs.k8s.io/docs/st</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 解决方法:</span></span><br><span class="line">minikube start --vm-driver=none</span><br><span class="line">[root@ops ~]<span class="hljs-comment"># minikube start --vm-driver=none</span></span><br><span class="line">😄  minikube v1.7.3 on Centos 7.2.1511</span><br><span class="line">   Using the none driver based on user configuration</span><br><span class="line">🤹  Running on localhost (CPUs=2, Memory=1989MB, Disk=20462MB) ...</span><br><span class="line">ℹ️    OS release is CentOS Linux 7 (Core)</span><br><span class="line">🐳  Preparing Kubernetes v1.17.3 on Docker 19.03.6 ...</span><br><span class="line">💾  Downloading kubectl v1.17.3</span><br><span class="line">💾  Downloading kubeadm v1.17.3</span><br><span class="line">💾  Downloading kubelet v1.17.3</span><br><span class="line">🚀  Launching Kubernetes ...</span><br><span class="line">...</span><br><span class="line">⚠️  The <span class="hljs-string">'none'</span> driver provides limited isolation and may reduce system security and reliability.</span><br><span class="line">⚠️  For more information, see:</span><br><span class="line">👉  https://minikube.sigs.k8s.io/docs/reference/drivers/none/</span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
<h3 id="可能会出现的错误"><a href="#可能会出现的错误" class="headerlink" title="可能会出现的错误"></a>可能会出现的错误</h3><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">[root@ops ~]<span class="hljs-comment"># minikube start --vm-driver=none</span></span><br><span class="line">😄  minikube v1.7.3 on Centos 7.2.1511</span><br><span class="line">✨  Using the none driver based on user configuration</span><br><span class="line">⌛  Reconfiguring existing host ...</span><br><span class="line">🔄  Starting existing none VM <span class="hljs-keyword">for</span> <span class="hljs-string">"minikube"</span> ...</span><br><span class="line">ℹ️   OS release is CentOS Linux 7 (Core)</span><br><span class="line">🐳  Preparing Kubernetes v1.17.3 on Docker 19.03.6 ...</span><br><span class="line">🚀  Launching Kubernetes ...</span><br><span class="line"></span><br><span class="line">💣  Error starting cluster: init failed. output: <span class="hljs-string">"-- stdout --\n[init] Using Kubernetes version: v1.17.3\n[preflight] Running pre-flight checks\n\n-- /stdout --\n** stderr ** \nW0225 12:50:34</span></span><br><span class="line"><span class="hljs-string">.116477   31929 validation.go:28] Cannot validate kube-proxy config - no validator is available\nW0225 12:50:34.116548   31929 validation.go:28] Cannot validate kubelet config - no validator</span></span><br><span class="line"><span class="hljs-string">is available\n\t[WARNING Service-Docker]: docker service is not enabled, please run 'systemctl enable docker.service'\n\t[WARNING IsDockerSystemdCheck]: detected \"cgroupfs\" as the Docker cg</span></span><br><span class="line"><span class="hljs-string">roup driver. The recommended driver is \"systemd\". Please follow the guide at https://kubernetes.io/docs/setup/cri/\n\t[WARNING Hostname]: hostname \"ops.novalocal\" could not be reached\n\t</span></span><br><span class="line"><span class="hljs-string">[WARNING Hostname]: hostname \"ops.novalocal\": lookup ops.novalocal on 114.114.114.114:53: no such host\n\t[WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl en</span></span><br><span class="line"><span class="hljs-string">able kubelet.service'\nerror execution phase preflight: [preflight] Some fatal errors occurred:\n\t[ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridg</span></span><br><span class="line"><span class="hljs-string">e-nf-call-iptables contents are not set to 1\n[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`\nTo see the stack trace of this e</span></span><br><span class="line"><span class="hljs-string">rror execute with --v=5 or higher\n\n** /stderr **"</span>: /bin/bash -c <span class="hljs-string">"sudo env PATH=/var/lib/minikube/binaries/v1.17.3:<span class="hljs-variable">$PATH</span> kubeadm init --config /var/tmp/minikube/kubeadm.yaml  --ignore-prefli</span></span><br><span class="line"><span class="hljs-string">ght-errors=DirAvailable--etc-kubernetes-manifests,DirAvailable--var-lib-minikube,DirAvailable--var-lib-minikube-etcd,FileAvailable--etc-kubernetes-manifests-kube-scheduler.yaml,FileAvailable-</span></span><br><span class="line"><span class="hljs-string">-etc-kubernetes-manifests-kube-apiserver.yaml,FileAvailable--etc-kubernetes-manifests-kube-controller-manager.yaml,FileAvailable--etc-kubernetes-manifests-etcd.yaml,Port-10250,Swap,SystemVeri</span></span><br><span class="line"><span class="hljs-string">fication"</span>: <span class="hljs-built_in">exit</span> status 1</span><br><span class="line">stdout:</span><br><span class="line">[init] Using Kubernetes version: v1.17.3</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line"></span><br><span class="line">stderr:</span><br><span class="line">W0225 12:50:34.116477   31929 validation.go:28] Cannot validate kube-proxy config - no validator is available</span><br><span class="line">W0225 12:50:34.116548   31929 validation.go:28] Cannot validate kubelet config - no validator is available</span><br><span class="line">        [WARNING Service-Docker]: docker service is not enabled, please run <span class="hljs-string">'systemctl enable docker.service'</span></span><br><span class="line">        [WARNING IsDockerSystemdCheck]: detected <span class="hljs-string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="hljs-string">"systemd"</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br><span class="line">        [WARNING Hostname]: hostname <span class="hljs-string">"ops.novalocal"</span> could not be reached</span><br><span class="line">        [WARNING Hostname]: hostname <span class="hljs-string">"ops.novalocal"</span>: lookup ops.novalocal on 114.114.114.114:53: no such host</span><br><span class="line">        [WARNING Service-Kubelet]: kubelet service is not enabled, please run <span class="hljs-string">'systemctl enable kubelet.service'</span></span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">        [ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridge-nf-call-iptables contents are not <span class="hljs-built_in">set</span> to 1</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">😿  minikube is exiting due to an error. If the above message is not useful, open an issue:</span><br><span class="line">👉  https://github.com/kubernetes/minikube/issues/new/choose</span><br></pre></td></tr></tbody></table></figure>
<p>这里报错说是/proc/sys/net/bridge/bridge-nf-call-iptables没有设置1<br>解决方法</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">echo</span> <span class="hljs-string">"1"</span> > /proc/sys/net/bridge/bridge-nf-call-iptables</span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">minikube搭建的单节点的过程中会需要一些时间，可能就卡着不动了</font></p>
<p>安装完成</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">[root@ops ~]<span class="hljs-comment"># minikube start --vm-driver=none</span></span><br><span class="line">😄  minikube v1.7.3 on Centos 7.2.1511</span><br><span class="line">✨  Using the none driver based on user configuration</span><br><span class="line">⌛  Reconfiguring existing host ...</span><br><span class="line">🏃  Using the running none <span class="hljs-string">"minikube"</span> VM ...</span><br><span class="line">ℹ️   OS release is CentOS Linux 7 (Core)</span><br><span class="line">🐳  Preparing Kubernetes v1.17.3 on Docker 19.03.6 ...</span><br><span class="line">🚀  Launching Kubernetes ...</span><br><span class="line"></span><br><span class="line">🌟  Enabling addons: default-storageclass, storage-provisioner</span><br><span class="line">🤹  Configuring <span class="hljs-built_in">local</span> host environment ...</span><br><span class="line"></span><br><span class="line">⚠️  The <span class="hljs-string">'none'</span> driver provides limited isolation and may reduce system security and reliability.</span><br><span class="line">⚠️  For more information, see:</span><br><span class="line">👉  https://minikube.sigs.k8s.io/docs/reference/drivers/none/</span><br><span class="line"></span><br><span class="line">⚠️  kubectl and minikube configuration will be stored <span class="hljs-keyword">in</span> /root</span><br><span class="line">⚠️  To use kubectl or minikube commands as your own user, you may need to relocate them. For example, to overwrite your own settings, run:</span><br><span class="line"></span><br><span class="line">    ▪ sudo mv /root/.kube /root/.minikube <span class="hljs-variable">$HOME</span></span><br><span class="line">    ▪ sudo chown -R <span class="hljs-variable">$USER</span> <span class="hljs-variable">$HOME</span>/.kube <span class="hljs-variable">$HOME</span>/.minikube</span><br><span class="line"></span><br><span class="line">💡  This can also be <span class="hljs-keyword">done</span> automatically by setting the env var CHANGE_MINIKUBE_NONE_USER=<span class="hljs-literal">true</span></span><br><span class="line">🏄  Done! kubectl is now configured to use <span class="hljs-string">"minikube"</span></span><br></pre></td></tr></tbody></table></figure>

<p><font color="red">使用minikub ssh 进入容器，如果你是在Linux机器上的还，是无法使用minikub ssh 登陆的，因为你已经在minikue节点上了</font></p>
<h2 id="使用k8s搭建多节点集群"><a href="#使用k8s搭建多节点集群" class="headerlink" title="使用k8s搭建多节点集群"></a>使用k8s搭建多节点集群</h2><p>机器分配<br>10.0.6.55 master<br>10.0.5.233 node1<br>10.0.5.196 node2</p>
<p>kubeadm init on master node</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">sudo kubeadm init --pod-network-cidr 172.100.0.0/16 --apiserver-advertise-address 192.168.205.120  <span class="hljs-comment"># 192.168.205.120 is master node ip</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># result</span></span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="hljs-variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="hljs-string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 10.0.6.55:6443 --token dbw4qc.ey3dpkozmv8yb15t \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:b1c47bc371709d90c6c381e6f3c7c9c034a7dcbfc585b18260016d480aab24a8</span><br></pre></td></tr></tbody></table></figure>
<p>继续运行</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">mkdir -p <span class="hljs-variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config</span><br></pre></td></tr></tbody></table></figure>
<p>检查pod </p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">[root@manager55 ~]<span class="hljs-comment"># kubectl get pod --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-6955765f44-2d7b4            0/1     Pending   0          7m34s   <span class="hljs-comment"># 这两个是网络插件后面安装</span></span><br><span class="line">kube-system   coredns-6955765f44-hmg9g            0/1     Pending   0          7m34s</span><br><span class="line">kube-system   etcd-manager55                      1/1     Running   0          7m49s</span><br><span class="line">kube-system   kube-apiserver-manager55            1/1     Running   0          7m49s</span><br><span class="line">kube-system   kube-controller-manager-manager55   1/1     Running   0          7m49s</span><br><span class="line">kube-system   kube-proxy-v8dxm                    1/1     Running   0          7m34s</span><br><span class="line">kube-system   kube-scheduler-manager55            1/1     Running   0          7m49s</span><br></pre></td></tr></tbody></table></figure>
<p>安装网络插件</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">kubectl apply -f <span class="hljs-string">"https://cloud.weave.works/k8s/net?k8s-version=<span class="hljs-variable">$(kubectl version | base64 | tr -d '\n')</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<p>检查网络插件</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">[root@manager55 ~]<span class="hljs-comment"># kubectl get pod --all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-6955765f44-2d7b4            1/1     Running   0          9m1s</span><br><span class="line">kube-system   coredns-6955765f44-hmg9g            1/1     Running   0          9m1s</span><br><span class="line">kube-system   etcd-manager55                      1/1     Running   0          9m16s</span><br><span class="line">kube-system   kube-apiserver-manager55            1/1     Running   0          9m16s</span><br><span class="line">kube-system   kube-controller-manager-manager55   1/1     Running   0          9m16s</span><br><span class="line">kube-system   kube-proxy-v8dxm                    1/1     Running   0          9m1s</span><br><span class="line">kube-system   kube-scheduler-manager55            1/1     Running   0          9m16s</span><br><span class="line">kube-system   weave-net-bf5jp                     2/2     Running   0          42s</span><br></pre></td></tr></tbody></table></figure>

<p>将其他node机器加入到master主机群下面</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">kubeadm join 10.0.6.55:6443 --token dbw4qc.ey3dpkozmv8yb15t \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:b1c47bc371709d90c6c381e6f3c7c9c034a7dcbfc585b18260016d480aab24a8</span><br></pre></td></tr></tbody></table></figure>
<p>在master主机上查看node节点加入情况</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># 加入node 前</span></span><br><span class="line">[root@manager55 ~]<span class="hljs-comment"># kubectl get nodes</span></span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">manager55   Ready    master   11m   v1.17.2 </span><br><span class="line"><span class="hljs-comment"># 加入之后</span></span><br><span class="line">[root@manager55 ~]<span class="hljs-comment"># kubectl get nodes</span></span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">manager55   Ready    master   60m   v1.17.2</span><br><span class="line">work196     Ready    <none>   34m   v1.17.2</span><br><span class="line">work233     Ready    <none>   15m   v1.17.2</span><br></pre></td></tr></tbody></table></figure>


<h2 id="构建docker-k8s系统环境脚本"><a href="#构建docker-k8s系统环境脚本" class="headerlink" title="构建docker+k8s系统环境脚本"></a>构建docker+k8s系统环境脚本</h2><p><font color="red">centos7版本</font></p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">#/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># install some tools</span></span><br><span class="line">sudo yum install -y vim telnet <span class="hljs-built_in">bind</span>-utils wget</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># install docker</span></span><br><span class="line">curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line">sh get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> [ ! $(getent group docker) ];</span><br><span class="line"><span class="hljs-keyword">then</span>·</span><br><span class="line">    sudo groupadd docker;</span><br><span class="line"><span class="hljs-keyword">else</span></span><br><span class="line">    <span class="hljs-built_in">echo</span> <span class="hljs-string">"docker user group already exists"</span></span><br><span class="line"><span class="hljs-keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo gpasswd -a <span class="hljs-variable">$USER</span> docker</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line">rm -rf get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># open password auth for backup if ssh key doesn't work, bydefault, username=vagrant password=vagrant</span></span><br><span class="line">sudo sed -i <span class="hljs-string">'s/PasswordAuthentication no/PasswordAuthentication yes/g'</span> /etc/ssh/sshd_config</span><br><span class="line">sudo systemctl restart sshd</span><br><span class="line"></span><br><span class="line">sudo bash -c <span class="hljs-string">'cat <<EOF > /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="hljs-string">[kubernetes]</span></span><br><span class="line"><span class="hljs-string">name=Kubernetes</span></span><br><span class="line"><span class="hljs-string">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="hljs-string">enabled=1</span></span><br><span class="line"><span class="hljs-string">gpgcheck=1</span></span><br><span class="line"><span class="hljs-string">repo_gpgcheck=1</span></span><br><span class="line"><span class="hljs-string">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="hljs-string">EOF'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 也可以尝试国内的源 http://ljchen.net/2018/10/23/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F%E7%AB%99%E5%AE%89%E8%A3%85ku⟫</span></span><br><span class="line"></span><br><span class="line">sudo setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># install kubeadm, kubectl, and kubelet.</span></span><br><span class="line">sudo yum install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line">sudo bash -c <span class="hljs-string">'cat <<EOF >  /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="hljs-string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="hljs-string">EOF'</span></span><br><span class="line">sudo sysctl --system</span><br><span class="line"></span><br><span class="line">sudo systemctl stop firewalld</span><br><span class="line">sudo systemctl <span class="hljs-built_in">disable</span> firewalld</span><br><span class="line">sudo swapoff -a</span><br><span class="line"></span><br><span class="line">systemctl <span class="hljs-built_in">enable</span> docker.service</span><br><span class="line">systemctl <span class="hljs-built_in">enable</span> kubelet.service</span><br></pre></td></tr></tbody></table></figure>



<h2 id="使用kubectl"><a href="#使用kubectl" class="headerlink" title="使用kubectl"></a>使用kubectl</h2><p>在linux下面使用</p>
<figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment"># 查看补足帮助，里面会给出一些各个环境的补足帮助</span></span><br><span class="line">kubectl  completion  -h</span><br><span class="line"><span class="hljs-comment"># linux下的补足</span></span><br><span class="line"><span class="hljs-built_in">source</span> <(kubectl completion bash)</span><br></pre></td></tr></tbody></table></figure></body></html>
        </div>
        
            <ul class="post-copyright">
            <li><strong>本文标题：</strong><a href="http://blog.noback.top/posts/7cebdf57/">docker-k8s</a></li>
            <li><strong>本文作者：</strong><a href="http://blog.noback.top">何泽君</a></li>
            <li><strong>本文链接：</strong><a href="http://blog.noback.top/posts/7cebdf57/">http://blog.noback.top/posts/7cebdf57/</a></li>
            <li><strong>发布时间：</strong>2020-02-10</li>
            <li><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
            </li>
            </ul>
        
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/posts/6e725c12/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">k8s常见错误</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/posts/1976fb59/">
                <span class="level-item">docker-swarm-wordpress</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<script>
    var disqus_config = function () {
        this.page.url = 'http://blog.noback.top/posts/7cebdf57/';
        this.page.identifier = 'posts/7cebdf57/';
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'alphalxy-blog' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
    </div>
</div>

</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level" style="margin-bottom:1rem">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-96x96 has-mb-6" src="http://image.noback.top/dataheader.jpeg" alt="">
                    
                    
                    
                    <p class="is-size-6 is-block">
                        hzj
                    </p>
                    
                    
                </div>
            </div>
        </nav>
        <nav class="level menu-list is-mobile" style="margin-bottom:1rem">
            <div class="level-item has-text-centered is-marginless">
                <a href="/archives/">
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        107
                    </p>
                </a>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <a href="/categories/">
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        27
                    </p>
                </a>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <a href="/tags/">
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        22
                    </p>
                </a>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="/" target="_blank">
                <i class="fab fa-github"></i>&nbsp;&nbsp;关注我</a>
        </div>
        
        
    </div>
</div>

    
        
<div class="card widget column-left is-sticky"   style="max-height: 900px; overflow: auto;" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#docker-k8s">
        <span class="has-mr-6">1</span>
        <span>docker-k8s</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#安装k8s及其管理工具">
        <span class="has-mr-6">1.1</span>
        <span>安装k8s及其管理工具</span>
        </a></li><li>
        <a class="is-flex" href="#k8s单节点环境-minikube">
        <span class="has-mr-6">1.2</span>
        <span>k8s单节点环境 minikube</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#可能会出现的错误">
        <span class="has-mr-6">1.2.1</span>
        <span>可能会出现的错误</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#使用k8s搭建多节点集群">
        <span class="has-mr-6">1.3</span>
        <span>使用k8s搭建多节点集群</span>
        </a></li><li>
        <a class="is-flex" href="#构建docker-k8s系统环境脚本">
        <span class="has-mr-6">1.4</span>
        <span>构建docker+k8s系统环境脚本</span>
        </a></li><li>
        <a class="is-flex" href="#使用kubectl">
        <span class="has-mr-6">1.5</span>
        <span>使用kubectl</span>
        </a></li></ul></li></ul>
        </div>
    </div>
</div>


    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>


                

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="http://image.noback.top/datadog.svg" alt="docker-k8s" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 何泽君&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                <br>
                <span id="busuanzi_container_site_uv">
                共<span id="busuanzi_value_site_uv">0</span>个访客
                </span>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                        
                        <i class="fab fa-creative-commons"></i>&nbsp;<i class="fab fa-creative-commons-by"></i>&nbsp;<i class="fab fa-creative-commons-nc"></i>&nbsp;<i class="fab fa-creative-commons-sa"></i>&nbsp;
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="AlphaLxy GitHub" href="https://www.github.com/AlphaLxy">
                        
                        <i class="fab fa-github"></i>&nbsp;
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>
